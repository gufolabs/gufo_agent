#!/bin/sh
set -x -e
# Get version
VERSION="$1"
if [ -z "$VERSION" ]; then
    echo "VERSION is not set"
    exit 1
fi
echo "Building gufo-agent ${VERSION}"
# Create dist
[ -d dist/ ] || mkdir dist
# Define build function
# $1 - rust target
# $2 - distribution platform name
build_target_tgz()
{
    # Build
    cross build --release --target $1
    # Copy binary distribution
    (
        cd target/$1/release \
        && tar cfz gufo-agent.tgz gufo-agent \
        && mv gufo-agent.tgz ../../../dist/gufo-agent-${VERSION}_$2.tgz
    )
}
# Build debian package
# $1 - arch
build_deb()
{
    arch=$1
    root="dist/deb/$arch"
    # Cleanup and recreate directory
    [ -d $root ] && rm -r $root
    mkdir -p $root
    # Inner directory structure
    mkdir -p "$root/DEBIAN"
    mkdir -p "$root/usr/bin"
    mkdir -p "$root/usr/share/man/man1"
    # Copy binary
    tar -x -z -f ./dist/gufo-agent-${VERSION}_linux_$arch.tgz -C $root/usr/bin
    # Copy man
    cp man/gufo-agent.1 $root/usr/share/man/man1
    # Get package size
    PACKAGE_ROOT_SIZE_BYTES=$(du -bcs --exclude=DEBIAN $root | head -1 | awk '{print $1}' | sed -e s/^0\+//)
    # To kB
    INPUT_INSTALLED_SIZE="$(awk -v size="$PACKAGE_ROOT_SIZE_BYTES" 'BEGIN {print (size/1024)+1}' | awk '{print int($0)}')"
    # Write DEBIAN/control
    cat > $root/DEBIAN/control << __EOF__
Package: gufo-agent
Version: ${VERSION}
Installed-Size: ${INPUT_INSTALLED_SIZE}
Architecture: ${arch}
Maintainer: Gufo Labs
Description: An universal agent for infrastructure monitoring
__EOF__
    # Build deb
    dpkg-deb -Zgzip -b $root "dist/gufo-agent_${VERSION}_${arch}.deb"
}
# Build rpm package
# $1 - rust arch
# $2 - rpm arch
build_rpm()
{
    arch=$2
    # Prepare rpmbuild
    rpmbuild_root="dist/rpmbuild"
    mkdir -p $rpmbuild_root/BUILD
    mkdir -p $rpmbuild_root/BUILDROOT
    mkdir -p $rpmbuild_root/RPMS
    mkdir -p $rpmbuild_root/SOURCES
    mkdir -p $rpmbuild_root/SPECS
    mkdir -p $rpmbuild_root/SRPMS
    # Prepare spec
    cat > $rpmbuild_root/SPECS/gufo-agent.spec << __EOF__
# This spec is generated by build-all.sh
# Do not modify directly
Name: gufo-agent
Version: ${VERSION}
Release: 1.el7
Group: System
Summary: An universal agent for infrastructure monitoring
BuildArch: ${arch}
BuildRoot: ./dist/rpmbuild
Source: gufo-agent-${VERSION}.tar.gz
License: BSD
URL: https://docs.gufolabs.com/gufo-agent/
Packager: Gufo Labs

%description
An universal agent for infrastructure monitoring

%files
/usr/bin/*
/usr/share/man/man1/*
__EOF__
    # Create image
    root="$rpmbuild_root/BUILDROOT/gufo-agent-${VERSION}-1.el7.$arch"
    # Inner directory structure
    mkdir -p "$root/usr/bin"
    mkdir -p "$root/usr/share/man/man1"
    # Copy binary
    tar -x -z -f ./dist/gufo-agent-${VERSION}_linux_$1.tgz -C $root/usr/bin
    # Copy man
    cp man/gufo-agent.1 $root/usr/share/man/man1
    # Build RPM
    rpmbuild -v -bb --define "_topdir $(pwd)/$rpmbuild_root" $rpmbuild_root/SPECS/gufo-agent.spec
    # Move to dist
    mv dist/rpmbuild/RPMS/${arch}/*.rpm dist/
}
# Build x86_64-unknown-linux-gnu + deb
build_target_tgz x86_64-unknown-linux-gnu linux_amd64
build_deb amd64
build_rpm amd64 x86_64
# Build aarch64-unknown-linux-gnu + deb
build_target_tgz aarch64-unknown-linux-gnu linux_aarch64
build_deb aarch64
# build_rpm aarch64 aarch64
